# 讀音來源說明：pykakasi 與訓讀／替代方案

## 一、pykakasi 為什麼「震」→ しん、「震わせて」辨識不到 ふるわせて？

### 1. 不是設定問題，是設計與字典特性

- **pykakasi** 源自 **KAKASI**（Kanji Kana Simple Inverter）：做的是「漢字→假名」的**字典最長匹配**，不是「先斷詞、再查每個詞的讀音」。
- 字典裡一個漢字往往有多種讀音（音讀・訓讀），但**沒有句法／語境**時，多數實作會偏向選**音讀**（例如 震→しん），尤其是單字查詢。
- **震わせて** 是動詞「震わせる」的活用形，正確讀音 ふるわせて 屬於**訓讀**。要對這種「整詞」給出正確讀音，需要：
  - 先做**形態解析／斷詞**，認出這是一個「詞」；
  - 再在**詞彙級字典**裡查「震わせて」→ ふるわせて。
- pykakasi 的流程是：從左到右、用字典做最長匹配，**沒有「先斷詞再查詞讀音」**這一步，所以很難在「震わせて」這種詞上選到訓讀 ふるわせて，多半會拆成「震」+ 其他，然後「震」被讀成 しん。

所以：**不是你把 pykakasi 設錯，而是它本來就偏重音讀、且不做「依文脈選訓讀」的形態解析**，這屬於函式庫的設計與能力邊界。

---

## 二、替代方案（要「震わせて→ふるわせて」這類訓讀時）

以下都是「可考慮」的替代，實作前建議先小規模試跑。

### 方案 A：MeCab + UniDic（例如透過 fugashi）

- **做法**：用 **MeCab** 做日文斷詞／形態解析，字典用 **UniDic**；每個 token 會有「表記」與「讀音」欄位，讀音多為該詞在字典裡的讀法（含訓讀）。
- **Python**：可用 **fugashi**（MeCab 的 Cython 包裝）+ **unidic** 或 **unidic-lite**。
- **優點**：  
  - 會把「震わせて」切成一個（或合理）的詞，並從 UniDic 取出讀音 ふるわせて。  
  - 本地執行、不需 API，適合 rasporuno/rasrss 這種自架服務。
- **缺點**：  
  - 需安裝 MeCab 與字典（fugashi 有提供 wheel 與 unidic-lite）；  
  - 字典體積比 pykakasi 大。

**範例流程**：整句送 MeCab → 取得每個 token 的 surface + reading → 對「使用者點到的字串」對齊到某個 token（或連續 token），用該 token 的 reading 當讀音。

### 方案 B：SudachiPy

- **做法**：另一套日文斷詞／形態解析，也有「表記＋讀音」。
- **優點**：純 Python、不依賴 MeCab；字典內建。
- **缺點**：讀音欄位是否完整支援「振り仮名」要實測（依版本而異）。

### 方案 C：外部 API（若有預算／可接受依賴）

- **做法**：使用有提供「假名標註」或「讀音」的服務，例如部分翻譯／NLP API 會回傳 per-word 或 per-character 的讀音。
- **優點**：常能拿到較好的文脈讀音（含訓讀）。
- **缺點**：需網路、可能付費、延遲與隱私要納入考量。

### 方案 D：維持 pykakasi + 「較長範圍」補救（你現在的做法）

- **做法**：維持目前 pykakasi 當第一線；使用者點「震」看到 しん 時，用「>」再查較長範圍，對「震わせて」整段再呼叫一次 pykakasi。
- **實測**：若對整段「震わせて」呼叫 `to_furigana("震わせて")`，pykakasi 有機會回傳 ふるわせて（整串一起轉時，字典可能匹配到較長條目）；若仍回 しんわせて 之類，就代表字典／演算法在這種詞上就是不支援，只能依賴方案 A/B/C。
- **建議**：先在後端手動試 `to_furigana("震わせて")` 的結果，再決定要不要加一層「較長範圍先查再顯示」。

---

## 三、建議順序（實務上）

1. **先確認**：在目前環境對 `to_furigana("震わせて")` 實際呼叫一次，看 pykakasi 回傳什麼。
2. **若 pykakasi 對「震わせて」整串也無法得到 ふるわせて**：  
   → 考慮引入 **fugashi + unidic-lite**（或 unidic），用 MeCab 的斷詞＋UniDic 讀音當「讀音來源」，必要時與 pykakasi 並存（例如：有 MeCab 結果就用 MeCab 讀音，否則 fallback pykakasi）。
3. **若不想加依賴**：維持 pykakasi + 較長範圍 UI，並在文件／介面說明「複雜訓讀可能不準，可多用較長範圍試試」。

---

## 四、小結

| 問題 | 說明 |
|------|------|
| 是設定問題嗎？ | **不是**，pykakasi 沒有「強制訓讀」的設定，它本來就偏字典最長匹配、常出音讀。 |
| 是 pykakasi 太弱嗎？ | 在「需要文脈的訓讀／動詞活用」上，**是的**；它不做形態解析，不適合當「詞彙級訓讀」的唯一來源。 |
| 替代方案 | **MeCab + UniDic（fugashi）** 最適合本地、且能處理「震わせて→ふるわせて」這類需求；其次 SudachiPy 或外部 API。 |
| 建議 | 先測 `to_furigana("震わせて")`；若不行，再規劃把讀音來源改為或補上 MeCab/UniDic。 |
